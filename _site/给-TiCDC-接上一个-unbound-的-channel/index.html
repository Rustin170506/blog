<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç»™ TiCDC æ¥ä¸Šä¸€ä¸ª unbound çš„ channel - Rustin</title>
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,300,700" type="text/css">
  <link rel="stylesheet" href="/static/app.css" type="text/css">
  <link rel="stylesheet" href="/static/syntax.css" type="text/css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" />
  <meta name="theme-color" content="#111111">

  <meta name="og:type" content="article">
  <meta name="og:title" content="ç»™ TiCDC æ¥ä¸Šä¸€ä¸ª unbound çš„ channel â€“ Rustin">
  <meta name="og:description" content="">
  <meta name="og:site_name" content="Rustin">
  <meta name="og:url" content="http://localhost:4000/%E7%BB%99-TiCDC-%E6%8E%A5%E4%B8%8A%E4%B8%80%E4%B8%AA-unbound-%E7%9A%84-channel/">
  
  <meta name="og:image" content="http://localhost:4000/static/default_image.jpg">
  
  <meta property="article:published_time" content=" 2022-07-10">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@hi_rustin">
  <meta name="twitter:domain" content="rustin.me">
  <meta name="twitter:title" content="ç»™ TiCDC æ¥ä¸Šä¸€ä¸ª unbound çš„ channel â€“ Rustin">
  <meta name="twitter:description" content="">
  
  <meta name="twitter:image" content="http://localhost:4000/static/default_image.jpg">
  
  <meta name="twitter:url" content="http://localhost:4000/%E7%BB%99-TiCDC-%E6%8E%A5%E4%B8%8A%E4%B8%80%E4%B8%AA-unbound-%E7%9A%84-channel/">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
</head>

<body>
  <header>
    <h1><a href="/">Rustin</a></h1>
    <span>Iâ€™m a passionate software engineer who specializes in distributed systems and dev tools.</span>
  </header>

  <div class="content post">
    <h2>ç»™ TiCDC æ¥ä¸Šä¸€ä¸ª unbound çš„ channel</h2>
    <p class="date">10 July 2022</p>

    <p>æœ€è¿‘åœ¨æ”¹é€  <a href="https://github.com/pingcap/tiflow">TiCDC</a> çš„ <a href="https://ticdc-sink.slides.rustin.me/">Sink</a> ç»„ä»¶æ—¶éœ€è¦ä¸º <a href="https://en.wikipedia.org/wiki/Message_queue">MQ</a> ç±»å‹çš„ Sink æ¥ä¸Šä¸€ä¸ª unbound çš„ <a href="https://go.dev/tour/concurrency/2">channel</a>ã€‚
åœ¨æœç´¢è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ä¸ªé¡¹ç›®å«åš <a href="https://github.com/golang-design/chann">chann</a>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ç»Ÿä¸€å¹¶ä¸”æ”¯æŒèŒƒå‹çš„ channelã€‚</p>

<p>è™½ç„¶è¿™ä¸ªåº“çœ‹ä¸Šå»å®ç°å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å¹¶ä¸æ˜¯å¾ˆé¡ºåˆ©ã€‚ä¸‹é¢æˆ‘å°±ä»‹ç»ä¸€ä¸‹æˆ‘åœ¨ä½¿ç”¨è¯¥åº“æ—¶é‡åˆ°çš„é—®é¢˜å’Œè¿›è¡Œçš„æ€è€ƒã€‚</p>

<p>æ­¤åšå®¢åœ¨ <a href="https://github.com/Rustin170506/rustin.me">GitHub</a> ä¸Šå…¬å¼€å‘å¸ƒã€‚ å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘é—®ï¼Œè¯·åœ¨æ­¤å¤„æ‰“å¼€ä¸€ä¸ª <a href="https://github.com/Rustin170506/rustin.me/issues">issue</a>ã€‚</p>

<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>è¯¥åº“ç”± golang ç¤¾åŒºéå¸¸æ´»è·ƒçš„ <a href="https://github.com/changkun">changkun</a> ç¼–å†™ï¼Œæ‰˜ç®¡åœ¨ä»–ç»„å»ºçš„ <a href="https://github.com/golang-design">golang-design</a> ç»„ç»‡ä¸‹ã€‚</p>

<p>å®ƒæä¾›äº†ç»Ÿä¸€çš„æ¥å£æ¥åˆ›å»ºä¸åŒç±»å‹çš„ channelï¼Œå¹¶ä¸”æ”¯æŒèŒƒå‹ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ch</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">int</span><span class="p">]()</span>                  <span class="c">// æ— ç•Œé™, æ— å®¹é‡é™åˆ¶</span>
<span class="n">ch</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="k">func</span><span class="p">()](</span><span class="n">chann</span><span class="o">.</span><span class="n">Cap</span><span class="p">(</span><span class="m">0</span><span class="p">))</span>   <span class="c">// æ²¡æœ‰ç¼“å­˜, å®¹é‡ä¸º 0</span>
<span class="n">ch</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="n">chann</span><span class="o">.</span><span class="n">Cap</span><span class="p">(</span><span class="m">100</span><span class="p">))</span> <span class="c">// æœ‰ç¼“å­˜ï¼Œå®¹é‡ä¸º 100</span>
</code></pre></div></div>

<p>å®ƒçš„å‘é€å’Œæ¥æ”¶æ“ä½œå’ŒåŸç”Ÿ channel ä¸€è‡´ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ch</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">42</span>
<span class="nb">println</span><span class="p">(</span><span class="o">&lt;-</span><span class="n">ch</span><span class="o">.</span><span class="n">Out</span><span class="p">())</span> <span class="c">// 42</span>
</code></pre></div></div>

<p>å®ƒçš„å…³é—­æ¥å£ä¸ºï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ch</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
</code></pre></div></div>

<p>ä»æ¥å£æ¥çœ‹ï¼Œå®ƒå‡ ä¹èƒ½æ— ç¼çš„æ¥å…¥åˆ°æˆ‘å½“å‰çš„é¡¹ç›®å½“ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘é€‰æ‹©å®ƒçš„åŸå› ã€‚</p>

<h2 id="æºç é˜…è¯»">æºç é˜…è¯»</h2>
<p>åœ¨å¼€å§‹åˆ†ææˆ‘é‡åˆ°çš„é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ·±å…¥é˜…è¯»ä¸€ä¸‹æºç ã€‚å®ƒçš„æºç ä¸æ˜¯å¾ˆé•¿ï¼Œå¹¶ä¸”æˆ‘ä¸»è¦æ˜¯ç”¨çš„æ˜¯æ— ç•Œé™çš„ channï¼Œæ‰€ä»¥ä¸‹é¢å°±ç€é‡çœ‹ä¸€ä¸‹æ— ç•Œé™çš„ chann çš„æºç ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Chann</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">]</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">in</span><span class="p">,</span> <span class="n">out</span> <span class="k">chan</span> <span class="n">T</span>
	<span class="nb">close</span>   <span class="k">chan</span> <span class="k">struct</span><span class="p">{}</span>
	<span class="n">cfg</span>     <span class="o">*</span><span class="n">config</span>
	<span class="n">q</span>       <span class="p">[]</span><span class="n">T</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Chann æ˜¯ä¸€ä¸ªèŒƒå‹ç»“æ„ä½“ï¼Œå®ƒé‡Œé¢ç»´æŠ¤äº† <code class="language-plaintext highlighter-rouge">in</code> å’Œ <code class="language-plaintext highlighter-rouge">out</code> channelï¼Œè¿™å°±æ˜¯æˆ‘ä»¬èƒ½ä½¿ç”¨åŸç”Ÿ channel è¯­æ³•æ“ä½œ chann çš„å…¥å£å’Œå‡ºå£ã€‚</p>

<p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„å­—æ®µæ˜¯ <code class="language-plaintext highlighter-rouge">q</code>ï¼Œå®ƒå°†è´Ÿè´£å­˜å‚¨ chann çš„ç¼“å­˜ã€‚</p>

<p>å®ƒçš„æ„é€ æ–¹æ³•ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">config</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">typ</span>      <span class="n">chanType</span>
	<span class="nb">len</span><span class="p">,</span> <span class="nb">cap</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Opt</span> <span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">)</span>

<span class="k">func</span> <span class="n">New</span><span class="p">[</span><span class="n">T</span> <span class="n">any</span><span class="p">](</span><span class="n">opts</span> <span class="o">...</span><span class="n">Opt</span><span class="p">)</span> <span class="o">*</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="p">{</span>
	<span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">{</span>
		<span class="nb">cap</span><span class="o">:</span> <span class="o">-</span><span class="m">1</span><span class="p">,</span> <span class="nb">len</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
		<span class="n">typ</span><span class="o">:</span> <span class="n">unbounded</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">"chann: too many arguments"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">opts</span> <span class="p">{</span>
		<span class="n">o</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">ch</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">]{</span><span class="n">cfg</span><span class="o">:</span> <span class="n">cfg</span><span class="p">,</span> <span class="nb">close</span><span class="o">:</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})}</span>
	<span class="k">switch</span> <span class="n">ch</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">typ</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">unbuffered</span><span class="o">:</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">in</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">T</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">in</span>
	<span class="k">case</span> <span class="n">buffered</span><span class="o">:</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">in</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">T</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="nb">cap</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">in</span>
	<span class="k">case</span> <span class="n">unbounded</span><span class="o">:</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">in</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">T</span><span class="p">,</span> <span class="m">16</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">T</span><span class="p">,</span> <span class="m">16</span><span class="p">)</span>
		<span class="k">go</span> <span class="n">ch</span><span class="o">.</span><span class="n">unboundedProcessing</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ch</span>
</code></pre></div></div>

<p>å®ƒçš„æ„é€ æ–¹æ³•æŠ½è±¡å‡ºäº†ä¸€ä¸ª Opts å¯é€‰å‚æ•°ï¼Œæ ¹æ®å®ƒæˆ‘ä»¬èƒ½å¤Ÿç»Ÿä¸€æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸ä¼ é€’ Opts å‚æ•°ä½¿ç”¨é»˜è®¤ config å°±è¡¨æ˜åˆ›å»ºäº†ä¸€ä¸ªæ— ç•Œé™çš„ channelã€‚<strong>æ³¨æ„ï¼šå¦‚æœæˆ‘ä»¬åˆ›å»ºçš„æ˜¯æ— ç•Œé™çš„ channï¼Œé‚£ä¹ˆå®ƒå°†å¯åŠ¨ä¸€ä¸ª goroutine æ¥å¤„ç†å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚åŒæ—¶å…¥å£å’Œå‡ºå£ channel çš„ç¼“å­˜é•¿åº¦ä¸º 16ã€‚</strong></p>

<p>æ¥ç€æ˜¯å®ƒçš„å‘é€å’Œæ¥æ”¶æ¥å£ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="n">In</span><span class="p">()</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="n">T</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ch</span><span class="o">.</span><span class="n">in</span> <span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="n">Out</span><span class="p">()</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="n">T</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="p">}</span>
</code></pre></div></div>
<p>åœ¨è¿™ä¸¤ä¸ªæ¥å£ä¸­æˆ‘ä»¬å°±æ˜¯ç›´æ¥è¿”å›äº† <code class="language-plaintext highlighter-rouge">in</code> å’Œ <code class="language-plaintext highlighter-rouge">out</code> channelï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥ä½¿ç”¨ go åŸç”Ÿçš„ channel è¯­æ³•æ¥æ“ä½œ channã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æ ¸å¿ƒé€»è¾‘ï¼Œå¦‚ä½•å¤„ç†æ•°æ®çš„å‘é€å’Œæ¥æ”¶ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="n">unboundedProcessing</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">nilT</span> <span class="n">T</span>

	<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">T</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="o">&lt;&lt;</span><span class="m">10</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="o">.</span><span class="n">in</span><span class="o">:</span>
			<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">"chann: send-only channel ch.In() closed unexpectedly"</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="n">atomic</span><span class="o">.</span><span class="n">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="nb">len</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="o">.</span><span class="nb">close</span><span class="o">:</span>
			<span class="n">ch</span><span class="o">.</span><span class="n">unboundedTerminate</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">:</span>
				<span class="n">atomic</span><span class="o">.</span><span class="n">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="nb">len</span><span class="p">,</span> <span class="o">-</span><span class="m">1</span><span class="p">)</span>
				<span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nilT</span>
				<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
			<span class="k">case</span> <span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="o">.</span><span class="n">in</span><span class="o">:</span>
				<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
					<span class="nb">panic</span><span class="p">(</span><span class="s">"chann: send-only channel ch.In() closed unexpectedly"</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="n">atomic</span><span class="o">.</span><span class="n">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="nb">len</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
				<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="o">.</span><span class="nb">close</span><span class="o">:</span>
				<span class="n">ch</span><span class="o">.</span><span class="n">unboundedTerminate</span><span class="p">()</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nb">cap</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="m">1</span><span class="o">&lt;&lt;</span><span class="m">5</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">T</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="o">&lt;&lt;</span><span class="m">10</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span><span class="n">Chann</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="n">unboundedTerminate</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">nilT</span> <span class="n">T</span>

	<span class="nb">close</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">in</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ch</span><span class="o">.</span><span class="n">in</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">:</span>
		<span class="k">default</span><span class="o">:</span>
		<span class="p">}</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nilT</span>
		<span class="n">ch</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="nb">close</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
	<span class="nb">close</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="nb">close</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å®ƒçš„ä¸»é€»è¾‘å°±æ˜¯ä¸€ä¸ª for å¾ªç¯ï¼š</p>
<ol>
  <li>åˆå§‹åŒ– <code class="language-plaintext highlighter-rouge">q</code>ï¼Œåˆå§‹å®¹é‡ä¸º 1024</li>
  <li>å¯åŠ¨ for å¾ªç¯ï¼Œ</li>
  <li>è¿›è¡Œ select æ“ä½œï¼Œå¦‚æœæœ‰æ•°æ®å¯ä»¥æ¥æ”¶ï¼Œåˆ™å­˜å…¥ <code class="language-plaintext highlighter-rouge">q</code> ç¼“å­˜ä¸­ï¼Œå¦åˆ™å¦‚æœæ˜¯ close åˆ™è¿›è¡Œå…³é—­æ“ä½œå¹¶é€€å‡º</li>
  <li>å¦‚æœå½“å‰ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œåˆ™å¯åŠ¨å†…å±‚å¾ªç¯</li>
  <li>è¿›è¡Œ select æ“ä½œï¼Œå°è¯•å‘é€ç¼“å­˜ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”åˆ é™¤å®ƒã€‚åŒæ—¶ä¹Ÿä¼šå°è¯•æ¥æ”¶æ–°çš„æ•°æ®ï¼Œå¦‚æœæœ‰æ–°æ•°æ®åˆ™å­˜å…¥ <code class="language-plaintext highlighter-rouge">q</code> ç¼“å­˜ä¸­ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯ close åˆ™è¿›è¡Œå…³é—­æ“ä½œå¹¶é€€å‡º</li>
  <li>å¦‚æœå½“å‰ç¼“å­˜ä¸­çš„æ•°æ®å·²ç»å…¨éƒ¨å‘é€å®Œæ¯•ï¼Œåˆ™é€€å‡ºå†…å±‚å¾ªç¯å¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œç„¶åè¿›å…¥ä¸‹ä¸€æ¬¡ä¸»å¾ªç¯</li>
</ol>

<p>å®ƒçš„å…³é—­æµç¨‹ï¼š</p>
<ol>
  <li>å…³é—­å…¥å£ channelï¼Œä¸å†æ¥æ”¶æ–°çš„æ•°æ®</li>
  <li>å°†å½“å‰å…¥å£ channel ä¸­çš„æ•°æ®å…¨éƒ¨ç¼“å­˜èµ·æ¥ç­‰å¾…å¤„ç†ï¼Œå°è¯•ä¼˜é›…çš„åœæœº</li>
  <li>å¦‚æœç¼“å­˜ä¸­æœ‰æ•°æ®çš„è¯ï¼Œåˆ™å¯åŠ¨ for å¾ªç¯ä¸æ–­çš„å°†æ•°æ®å‘é€ç»™å‡ºå£ channel</li>
  <li>æœ€ç»ˆæ‰€æœ‰æ•°æ®éƒ½å¤„ç†å®Œæ¯•ï¼Œåˆ™å…³é—­å‰©ä½™ channel</li>
</ol>

<p>ä»¥ä¸Šå°±æ˜¯å®ƒçš„æ ¸å¿ƒå®ç°ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯éå¸¸æ¸…æ™°å’Œç®€å•çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹æˆ‘åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼</p>

<h2 id="ä¸€ä¸ª-">ä¸€ä¸ª ğŸ›</h2>
<p>é¦–å…ˆæ˜¯æˆ‘åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ª bugï¼Œissue çš„é“¾æ¥ï¼šhttps://github.com/golang-design/chann/issues/3</p>

<p>æˆ‘å’ŒåŒäº‹åœ¨ä½¿ç”¨ chann è¿‡ç¨‹ä¸­å‘ç°å› ä¸ºå…³é—­æ“ä½œä¸å½“ä¼šå¯¼è‡´ cpu spinã€‚æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹çš„ä»£ç æ˜¯ç›®å‰æœ€æ–°çš„ä»£ç ï¼Œä½†æ˜¯åœ¨æˆ‘æŠ¥å‘Šè¿™ä¸ª issue ä¹‹å‰å®ƒçš„ close æ“ä½œçš„æ ¸å¿ƒé€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">:</span>
			    <span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nilT</span> <span class="c">// de-reference earlier to help GC</span>
				<span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
		<span class="k">default</span><span class="o">:</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>è¯·æ³¨æ„å®ƒå’Œä¸Šé¢çš„æ“ä½œå®Œå…¨æ˜¯ä¸¤ä¸ªè¯­ä¹‰ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">ch</span><span class="o">.</span><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">:</span>
		<span class="k">default</span><span class="o">:</span>
	<span class="p">}</span>
	<span class="n">q</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nilT</span> <span class="c">// de-reference earlier to help GC</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åŸæ¥çš„å†™æ³•ï¼Œåœ¨ close æ“ä½œä¹‹åå¦‚æœæ²¡æœ‰ receiver ç»§ç»­æ¥æ”¶æ•°æ®ï¼Œåˆ™ for å¾ªç¯ä¼šä¸€ç›´è¿›å…¥ default åˆ†æ”¯è¿›è¡Œæ­»å¾ªç¯ï¼Œå¯¼è‡´å‡ºç° cpu spinã€‚</p>

<p>è€Œç°åœ¨çš„åšæ³•æ˜¯ï¼Œå½“æ²¡æœ‰ receiver æ—¶ä¼šè¿›å…¥ default åˆ†æ”¯å¹¶ä¸”ç›´æ¥åˆ é™¤è¯¥æ•°æ®ï¼Œè¿™æ ·å°±èƒ½é˜²æ­¢å‡ºç°æ­»å¾ªç¯å¯¼è‡´ cpu spinã€‚</p>

<p>ç›®å‰è¿™æ ·çš„åšæ³•ä¹Ÿå¯¼è‡´äº†è¯­ä¹‰çš„å˜åŒ–ï¼Œæˆ‘ä»¬ç°åœ¨å®é™…ä¸Šå·²ç»åšä¸åˆ°ä¼˜é›…çš„åœæœºäº†ï¼Œå› ä¸ºå¾ˆæœ‰å¯èƒ½åœ¨ default åˆ†æ”¯è¢«æ‰§è¡Œä¹‹åæ¶ˆè´¹è€…ä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚å…·ä½“çš„ä¾‹å­å¯ä»¥æŸ¥çœ‹ <a href="https://github.com/changkun">changkun</a> çš„<a href="https://github.com/golang-design/chann/issues/3#issuecomment-1150189421">å›å¤</a>ã€‚</p>

<p>ç›®å‰è¿™ä¸ªé—®é¢˜è¿˜æ˜¯æ²¡æœ‰è¢«å®Œå…¨è§£å†³ï¼Œåœ¨æˆ‘ä¸ªäººæ¥çœ‹ï¼Œæˆ‘æ›´æ„¿æ„ä¿æŒåŸæ¥çš„åšæ³•è®©ç”¨æˆ·æ¥å¤„ç½®å‰©ä¸‹çš„æ•°æ®ï¼Œè¿™æ ·è¯­ä¹‰æ›´åŠ æ˜ç¡®ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åˆ é™¤åŸæ¥åšæ³•ä¸­çš„ default åˆ†æ”¯ï¼Œé˜²æ­¢å‡ºç°æ­»å¾ªç¯ã€‚è®©ç”¨æˆ·æ¥ä¿è¯æ¶ˆè´¹å®Œæ‰€æœ‰å‰©ä½™æ•°æ®é˜²æ­¢å‡ºç° goroutine æ³„æ¼ã€‚</p>

<p>ä½†è¿™åªæ˜¯æˆ‘ä¸ªäººçš„æƒ³æ³•ï¼Œ<a href="https://github.com/changkun">changkun</a> å®é™…ä¸Šä¸å¤ªè®¤å¯è¿™ä¸ªåšæ³•ï¼Œå› ä¸ºè¿˜æ˜¯å­˜åœ¨ goroutine æ³„æ¼çš„é£é™©ã€‚æœŸå¾…æˆ‘ä»¬æœ‰æ›´å¥½çš„æ–¹æ¡ˆèƒ½å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>å› ä¸ºè¯¥é—®é¢˜æ²¡æœ‰è¢«è§£å†³ï¼Œæ‰€ä»¥æˆ‘å†³å®šå°†ä»£ç  <a href="https://github.com/pingcap/tiflow/pull/5675">fork</a> åˆ° <a href="https://github.com/pingcap/tiflow">ticdc</a> ä»“åº“ä¸­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘åˆå‘ç°äº†ä¸€ä¸ªä¸ç¨³å®šçš„æµ‹è¯•ã€‚</p>

<h2 id="ä¸€ä¸ªä¸ç¨³å®šæµ‹è¯•">ä¸€ä¸ªä¸ç¨³å®šæµ‹è¯•</h2>
<p>åœ¨ fork ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç° <code class="language-plaintext highlighter-rouge">TestNonblockSelectRace</code> éå¸¸ä¸ç¨³å®šï¼Œåœ¨æˆ‘ä»¬çš„ CI ç³»ç»Ÿä¸­å‡ ä¹ç¨³å®šå¤±è´¥ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNonblockSelectRace</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">n</span> <span class="o">:=</span> <span class="m">1000</span>
	<span class="k">if</span> <span class="n">testing</span><span class="o">.</span><span class="n">Short</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="m">1000</span>
	<span class="p">}</span>
	<span class="n">done</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">bool</span><span class="p">](</span><span class="n">chann</span><span class="o">.</span><span class="n">Cap</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">c1</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">int</span><span class="p">]()</span>
		<span class="n">c2</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">int</span><span class="p">]()</span>
		<span class="n">c1</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">.</span><span class="n">Gosched</span><span class="p">()</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c1</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c2</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
			<span class="k">default</span><span class="o">:</span>
				<span class="n">done</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="no">false</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="n">done</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="no">true</span>
		<span class="p">}()</span>
		<span class="n">c2</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c1</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
		<span class="k">default</span><span class="o">:</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="o">!&lt;-</span><span class="n">done</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"no chan is ready"</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæµ‹è¯•çš„è¯­ä¹‰çš„ä¿è¯æ˜¯ï¼Œå½“æ•°æ®é€šè¿‡ In() æ¥å£è¢«å†™å…¥ä¹‹åï¼Œæˆ‘ä»¬æ€»æ˜¯ç«‹é©¬å°±èƒ½æ¶ˆè´¹åˆ°è¯¥æ•°æ®ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸èƒ½æä¾›è¿™ä¸ªè¯­ä¹‰ä¿è¯ï¼Œå› ä¸ºæ•°æ®è¢«å†™å…¥ä¹‹åè¿˜è¦ç­‰å¾…è¢«å†™å…¥ç¼“å­˜ä¸­ï¼Œæ‰æœ‰å¯èƒ½è¢«æ¶ˆè´¹åˆ°ã€‚</p>

<p>æˆ‘åšäº†ä¸€äº›ä¿®å¤é™ä½äº†è¿™ä¸ªé—®é¢˜å¤ç°çš„é¢‘ç‡ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ˜¯æ— æ³•ä¿è¯è¿™ä¸ªè¯­ä¹‰ï¼Œæ‰€ä»¥æœ€ç»ˆ <a href="https://github.com/golang-design/chann/pull/2">PR</a> è¿˜æ˜¯æ²¡æœ‰è¢«æ¥å—ã€‚</p>

<p>æœ€ç»ˆ <a href="https://github.com/changkun">changkun</a> æäº¤äº†ä»£ç æ˜ç¡®äº†æˆ‘ä»¬æ²¡æœ‰è¿™ä¸ªè¯­ä¹‰ä¿è¯å¹¶ä¸”ä¿®å¤äº†è¿™ä¸ªä¸ç¨³å®šæµ‹è¯•ã€‚
æ–°çš„è¯­ä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
  <p>// An unbounded channel is not a buffered channel with infinite capacity,
and they have different memory model semantics in terms of receiving
a value: The recipient of a buffered channel is immediately available
after a send is complete. However, the recipient of an unbounded channel
may be available within a bounded time frame after a send is complete.</p>
</blockquote>

<p>ä»–æµ‹è¯•ä¿®æ”¹çš„ä¹Ÿå¾ˆå·§å¦™ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNonblockSelectRace</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">n</span> <span class="o">:=</span> <span class="m">1000</span>
	<span class="n">done</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">bool</span><span class="p">](</span><span class="n">chann</span><span class="o">.</span><span class="n">Cap</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">c1</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">int</span><span class="p">]()</span>
		<span class="n">c2</span> <span class="o">:=</span> <span class="n">chann</span><span class="o">.</span><span class="n">New</span><span class="p">[</span><span class="kt">int</span><span class="p">]()</span>

		<span class="c">// The input channel of an unbounded buffer have an internal</span>
		<span class="c">// cache queue. When the input channel and the internal cache</span>
		<span class="c">// queue both gets full, we are certain that once the next send</span>
		<span class="c">// is complete, the out will be available for sure hence the</span>
		<span class="c">// waiting time of a receive is bounded.</span>
		<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">internalCacheSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="n">c1</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="p">}</span>
		<span class="n">c1</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c1</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c2</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
			<span class="k">default</span><span class="o">:</span>
				<span class="n">done</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="no">false</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="n">done</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="no">true</span>
		<span class="p">}()</span>
		<span class="c">// Same for c2</span>
		<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">internalCacheSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="n">c2</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="p">}</span>
		<span class="n">c2</span><span class="o">.</span><span class="n">In</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="m">1</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">c1</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span><span class="o">:</span>
		<span class="k">default</span><span class="o">:</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="o">!&lt;-</span><span class="n">done</span><span class="o">.</span><span class="n">Out</span><span class="p">()</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"no chan is ready"</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å› ä¸ºæˆ‘ä»¬çš„ç¼“å­˜é˜Ÿåˆ—å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç¡®ä¿ç¼“å­˜å·²æ»¡ä¹‹åå†å†™å…¥æ—¶ï¼Œæˆ‘ä»¬æ€»ä¼šæœ‰è¶³å¤Ÿçš„æ—¶é—´æ”¶åˆ°å†™å…¥çš„æ•°æ®ã€‚</p>

<h2 id="å­¦åˆ°çš„å°æŠ€å·§">å­¦åˆ°çš„å°æŠ€å·§</h2>

<p>åœ¨ fork ä»£ç çš„è¿‡ç¨‹ä¸­å‘ç°äº†å‡ ä¸ª <a href="https://github.com/changkun">changkun</a> çš„ä»£ç ä¸­å¾ˆæœ‰ç”¨çš„æŠ€å·§ã€‚</p>

<ol>
  <li>åœ¨åˆ‡ç‰‡ä¸­çš„æ•°æ®è¢«æ¶ˆè´¹ä½¿ç”¨ä¹‹åï¼Œå°†å…¶è®¾ç½®ä¸º nilï¼Œå¹¶ä¸”åœ¨å®¹é‡ä¸è¶³æ—¶æ€»æ˜¯ make æ–°çš„åˆ‡ç‰‡ï¼Œè¿™æ ·ä¼šå¸®åŠ© GC æ›´å¿«å›æ”¶å†…å­˜ã€‚</li>
  <li>åˆ›å»º <code class="language-plaintext highlighter-rouge">export_test.go</code> æ–‡ä»¶å¯¼å‡ºæµ‹è¯•ä¸“ç”¨å‡½æ•°ï¼Œæ—¢èƒ½è®¿é—®åˆ°å†…éƒ¨çŠ¶æ€ï¼Œåˆä¸ç”¨å°†å•å…ƒæµ‹è¯•ä¹Ÿæ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸‹å¯¼è‡´æµ‹è¯•åˆ°å¤„éƒ½ä¾èµ–å†…éƒ¨çŠ¶æ€ã€‚</li>
  <li>åˆ©ç”¨ <code class="language-plaintext highlighter-rouge">runtime.GOMAXPROCS</code> å’Œ <code class="language-plaintext highlighter-rouge">runtime.NumGoroutine</code> æ¥æ„é€ ç‰¹å®š goroutine æµ‹è¯•åœºæ™¯å’Œæ£€æµ‹ goroutine æ³„æ¼ã€‚</li>
</ol>

<h3 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h3>

<p><a href="https://github.com/golang-design/chann">chann</a></p>

<p><a href="https://golang.design/research/ultimate-channel/">ultimate-channel</a></p>

<p><a href="https://stackoverflow.com/questions/50732829/will-gc-collect-the-objects-while-the-array-set-to-nil-in-golang">Will gc collect the objects while the array set to nil in Golang?</a></p>



    <p class="signature">&mdash; Rustin</p>
  </div>
  <script>
    (function () {
      anchors.options.placement = 'right';
      anchors.add('.content > h3, .content > h4, .content > h5, .content > h6');
    })();
  </script>
  <script src="https://giscus.app/client.js" data-repo="Rustin170506/blog"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyMTU4MDI0NDg=" data-category="Ideas" data-category-id="DIC_kwDODNziUM4CY_bg"
    data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top"
    data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async>
    </script>
</body>

</html>
